#!/usr/bin/env bash
NORMAL="^d^"
YELLOW="^c#FFCB6B^"
BRIGHT_YELLOW="^c#FFDC89^"
RED="^c#F07178^"
LIME="^c#DDFFA7^"
CYAN="^c#89DDFF^"
GREY="^c#D0D0D0^"
PURPLE="^c#C792EA^"
ORANGE="^c#F78C6C^"
GREEN="^c#C3E88D^"
BROWN="^c#9B859D^"
BLUE="^c#82AAFF^"

if [[ "$1" == "kill" ]]; then
  pkill -P $(pgrep -fx "bash /usr/local/bin/dwm-statusbar") -f sleep
  exit 0
fi

mem() {
  local mem_used
  mem_used=$(free -h | grep 'Mem')
  echo -e "$GREEN  ${mem_used:27:4}/7.6G$NORMAL"
}

cputemp() {
  local cpu_temp=$(($(</sys/class/hwmon/hwmon1/temp1_input) / 1000 ))
  printf "$CYAN $cpu_temp糖$NORMAL"
}

power() {
  local perc profile
  perc=$(</sys/class/power_supply/BAT1/capacity)
  profile=$(</sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)

  if [[ "$profile" == "performance" ]]; then
    [ "$perc" -ge 0 ]  && [ "$perc" -lt 10 ] && printf "$RED $perc $NORMAL"
    [ "$perc" -ge 10 ] && [ "$perc" -lt 20 ] && printf "$RED $perc $NORMAL"
    [ "$perc" -ge 20 ] && [ "$perc" -lt 30 ] && printf "$ORANGE $perc $NORMAL"
    [ "$perc" -ge 30 ] && [ "$perc" -lt 40 ] && printf "$ORANGE $perc $NORMAL"
    [ "$perc" -ge 40 ] && [ "$perc" -lt 50 ] && printf "$ORANGE $perc $NORMAL"
    [ "$perc" -ge 50 ] && [ "$perc" -lt 60 ] && printf "$YELLOW $perc $NORMAL"
    [ "$perc" -ge 60 ] && [ "$perc" -lt 70 ] && printf "$YELLOW $perc $NORMAL"
    [ "$perc" -ge 70 ] && [ "$perc" -lt 80 ] && printf "$GREEN $perc $NORMAL"
    [ "$perc" -ge 80 ] && [ "$perc" -le 90 ] && printf "$GREEN $perc $NORMAL"
    [ "$perc" -gt 90 ]                       && printf "$GREEN $perc $NORMAL"
  else
    [ "$perc" -ge 0 ]  && [ "$perc" -lt 10 ] && printf "$RED $perc $NORMAL"
    [ "$perc" -ge 10 ] && [ "$perc" -lt 20 ] && printf "$RED $perc $NORMAL"
    [ "$perc" -ge 20 ] && [ "$perc" -lt 30 ] && printf "$ORANGE $perc $NORMAL"
    [ "$perc" -ge 30 ] && [ "$perc" -lt 40 ] && printf "$ORANGE $perc $NORMAL"
    [ "$perc" -ge 40 ] && [ "$perc" -lt 50 ] && printf "$ORANGE $perc $NORMAL"
    [ "$perc" -ge 50 ] && [ "$perc" -lt 60 ] && printf "$YELLOW $perc $NORMAL"
    [ "$perc" -ge 60 ] && [ "$perc" -lt 70 ] && printf "$YELLOW $perc $NORMAL"
    [ "$perc" -ge 70 ] && [ "$perc" -lt 80 ] && printf "$GREEN $perc $NORMAL"
    [ "$perc" -ge 80 ] && [ "$perc" -le 90 ] && printf "$GREEN $perc $NORMAL"
    [ "$perc" -gt 90 ]                       && printf "$GREEN $perc $NORMAL"  
  fi
}

network() {
  local ip ssid latency
  ssid=$(iwgetid -r)
  ip=$(ip route get 8.8.8.8 | grep -Eo '[0-9.]+' | tail -2 | head -1)
  [[ -n $ip ]] && latency=$(ping -c1 8.8.8.8 | grep -Po "(?<=time=)(\d+\.\d+\ ms)")
  [[ -n $ssid ]] && printf "$RED直  $ssid $ip - $latency$NORMAL" || printf "$RED睊 NO CONNECTION$NORMAL"
  [[ -d /sys/class/net/tun0 ]] && printf "$RED - VPN $(ip a s tun0 | grep -Po "(?<=inet )\d+.\d+.\d+.\d+")$NORMAL" || printf " "
}

hddfree() {
  local freespc
  freespc=$(df -h --output='avail' / | tail -1 | tr -d ' ')
  printf "$ORANGE  $freespc$NORMAL"
}

volume() {
  local mix vol
  muted=$(pulsemixer --get-mute)
  vol=$(pulsemixer --get-volume | cut -d" " -f2)
  [[ $muted -eq 1 ]] && printf "$PURPLE婢  OFF$NORMAL" || printf "$PURPLE墳  $vol $NORMAL"
}

datetime() {
  printf "$BRIGHT_YELLOW  %(%a %d %b %H:%M)T$NORMAL" "-1"
}

current_song() {
  local title
  title=$(mocp --info | grep -Pow "(?<=Title: ).*" | head -1)
  [[ -n $title ]] && printf "$BROWN$title$NORMAL" || printf "$BROWNNOT PLAYING$NORMAL"
}

kbd_layout() {
  local layout
  layout=$(setxkbmap -query | grep -Po "(?<=layout:     )..")
  printf "$BLUE  $layout$NORMAL"
}

cpu_usage() {
  local usage
  usage=$(awk '{u=$2+$4; t=$2+$4+$5; if (NR==1){u1=u; t1=t;} else print ($2+$4-u1) * 100 / (t-t1); }' <(grep 'cpu ' /proc/stat) <(sleep 0.5;grep 'cpu ' /proc/stat))
  printf "%s  %.0f %s" $YELLOW "$usage" $NORMAL
}

while :; do xsetroot -name "$(kbd_layout) $(cpu_usage) $(mem) $(cputemp) $(power) $(network) $(hddfree) $(volume) $(datetime)"; sleep 30s; done
