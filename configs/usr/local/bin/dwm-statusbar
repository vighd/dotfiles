#!/bin/bash
#shellcheck disable=SC2046,2086

if [[ "$1" == "kill" ]]; then
  pkill -P $(pgrep -fx "/bin/bash /usr/local/bin/dwm-statusbar") -f sleep
  exit 0
fi

printColoredText() {
  prefix=$1
  color=$2
  text=$3
  suffix=$4

  echo -e "^c$color^$prefix  $text$suffix^d^"
}

getBatIcon() {
  percentage=$1
  chargerState=$2

  case $percentage in
    [0-9])
      [[ $chargerState -eq 1 ]] && echo "" || echo ""
      ;;
    1[0-9])
      [[ $chargerState -eq 1 ]]  && echo "" || echo ""
      ;;
    2[0-9])
      [[ $chargerState -eq 1 ]]  && echo "" || echo ""
      ;;
    3[0-9])
      [[ $chargerState -eq 1 ]]  && echo "" || echo ""
      ;;
    4[0-9] | 5[0-9]) 
      [[ $chargerState -eq 1 ]]  && echo "" || echo ""
      ;;
    6[0-9] | 7[0-9])
      [[ $chargerState -eq 1 ]]  && echo "" || echo ""
      ;;
    8[0-9])
      [[ $chargerState -eq 1 ]] && echo "" || echo ""
      ;;
    9[0-9])
      [[ $chargerState -eq 1 ]] && echo "" || echo ""
      ;;
    *)
      [[ $chargerState -eq 1 ]] && echo "" || echo ""
      ;;
  esac
}

round() {
  printf "%.${2}f" "${1}"
}

mem() {
  mem_used=$(free -h | grep 'Mem')
  printColoredText "" "#E5C07A" "${mem_used:27:4}/7.6G"
}

cpuTemp() {
  cpu_temp=$(($(< /sys/class/hwmon/hwmon1/temp1_input) / 1000))
  printColoredText "" "#62AEEF" $cpu_temp "°C"
}

power() {
  perc=$(< /sys/class/power_supply/BAT1/capacity)
  ac=$(< /sys/class/power_supply/AC/online)
  governorIcon=$(grep -q performance /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor && echo " ﮣ")
	batIcon=$(getBatIcon $perc $ac)

  if [[ -f /sys/class/power_supply/BAT1/capacity ]]; then
    printColoredText $batIcon "#C678DD" "$perc%$governorIcon"
  else
    printColoredText $batIcon "#C678DD" "NO BATTERY"
  fi
}

network() {
  ssid=$(iwgetid -r)
  ip=$(ip route get 8.8.8.8 | grep -Eo '[0-9.]+' | tail -2 | head -1)
  latency=$(ping -c1 8.8.8.8 | grep -Po "(?<=time=)(\d+\.\d+\ ms)")
  if [[ -n $ssid ]]; then
    if [[ -d /sys/class/net/tun0 ]]; then
      vpnIp=$(ip a s tun0 | grep -Po "(?<=inet )\d+.\d+.\d+.\d+")
      printColoredText "直" "#F9266A" "$ssid $ip - $latency" " 嬨 $vpnIp"
    else
      printColoredText "直" "#F9266A" "$ssid $ip - $latency"
    fi
  else
    printColoredText "睊" "#F9266A" "NO CONNECTION"
  fi

}

hddFree() {
  freespc=$(df -h --output='avail' / | tail -1 | tr -d ' ')
  printColoredText "" "#FE8019" $freespc
}

volume() {
  vol=$(round $(echo "$(wpctl get-volume @DEFAULT_AUDIO_SINK@ | cut -d ' ' -f 2) * 100" | bc))
  if wpctl get-volume @DEFAULT_AUDIO_SINK@ | grep -q MUTED; then
    printColoredText "婢" "#B8BB26" "OFF"
  else
    if [ $vol -ge 20 ] && [ $vol -le 40 ]; then
      printColoredText "奄" "#B8BB26" $vol "%"
    elif [ $vol -gt 40 ] && [ $vol -lt 70 ]; then
      printColoredText "奔" "#B8BB26" $vol "%"
    else
      printColoredText "墳" "#B8BB26" $vol "%"
    fi
  fi
}

dateTime() {
  printColoredText "" "#55B6C2" "$(date '+%a %d %b %H:%M')"
}

kbdLayout() {
  layout=$(setxkbmap -query | grep -Po "(?<=layout:     )..")
  printColoredText "" "#E06B74" $layout
}

cpuUsage() {
  usage=$(awk '{u=$2+$4; t=$2+$4+$5; if (NR==1){u1=u; t1=t;} else print ($2+$4-u1) * 100 / (t-t1); }' <(grep 'cpu ' /proc/stat) <(
    sleep 0.5
    grep 'cpu ' /proc/stat
  ))
  printColoredText "" "#98C379" $(round ${usage} 0) "%"
}

while :; do xsetroot -name "$(kbdLayout) $(cpuUsage) $(mem) $(cpuTemp) $(power) $(network) $(hddFree) $(volume) $(dateTime)"; sleep 30s; done
